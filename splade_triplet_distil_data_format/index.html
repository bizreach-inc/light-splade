<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../img/favicon.ico" />
    <title>Distillation-based - light-splade</title>
    <link rel="stylesheet" href="../css/theme.css" />
    <link rel="stylesheet" href="../css/theme_extra.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "Distillation-based";
        var mkdocs_page_input_path = "splade_triplet_distil_data_format.md";
        var mkdocs_page_url = null;
      </script>
    
    <!--[if lt IE 9]>
      <script src="../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
      <script>hljs.highlightAll();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href=".." class="icon icon-home"> light-splade
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="..">Home</a>
                </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../getting_started/">Getting Started</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">Data format</span></p>
              <ul class="current">
                  <li class="toctree-l1"><a class="reference internal" href="../splade_triplet_data_format/">Triplet-based</a>
                  </li>
                  <li class="toctree-l1 current"><a class="reference internal current" href="#">Distillation-based</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#overview">Overview</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#key-differences-from-standard-triplet-training">Key Differences from Standard Triplet Training</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#file-format-ndjson">File Format: NDJSON</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-file-specifications">Data File Specifications</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#1-query-master-file">1. Query Master File</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#2-document-master-file">2. Document Master File</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#3-positive-lists-file">3. Positive Lists File</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#4-hard-negative-scores-file">4. Hard Negative Scores File</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-organization">Data Organization</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#directory-structure">Directory Structure</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#configuration-example">Configuration Example</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sampling-modes">Sampling Modes</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#query-based-sampling-default-currently-supported">Query-Based Sampling (Default, Currently Supported)</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#positive-pair-based-sampling-future-support">Positive-Pair-Based Sampling (Future Support)</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#data-validation-rules">Data Validation Rules</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#dataset-output">Dataset Output</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#use-case">Use Case</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#generating-hard-negative-scores">Generating Hard Negative Scores</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#reference">Reference</a>
    </li>
    </ul>
                  </li>
              </ul>
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../trouble_shooting/">Troubleshooting</a>
                </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="..">light-splade</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href=".." class="icon icon-home" aria-label="Docs"></a></li>
          <li class="breadcrumb-item">Data format</li>
      <li class="breadcrumb-item active">Distillation-based</li>
    <li class="wy-breadcrumbs-aside">
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <!---
Copyright 2025 BizReach, Inc. All rights reserved.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->

<h1 id="splade-distillation-based-input-data-specification">SPLADE Distillation-based Input Data Specification<a class="headerlink" href="#splade-distillation-based-input-data-specification" title="Permanent link">&para;</a></h1>
<p>This document describes the input data format required for training SPLADE++ (Sparse Lexical and Expansion) models <strong>with knowledge distillation</strong> from a teacher model using the light-splade framework.</p>
<h2 id="overview">Overview<a class="headerlink" href="#overview" title="Permanent link">&para;</a></h2>
<p>SPLADE distillation-based dataset consists of four types of data files, all in <strong>NDJSON (Newline Delimited JSON)</strong> format:</p>
<ol>
<li><strong>Query Master</strong> - Contains query texts and their IDs</li>
<li><strong>Document Master</strong> - Contains document texts and their IDs</li>
<li><strong>Positive Lists</strong> - Maps queries to their relevant documents</li>
<li><strong>Hard Negative Scores</strong> - Contains similarity scores from a teacher model (e.g., cross-encoder) for query-document pairs</li>
</ol>
<h2 id="key-differences-from-standard-triplet-training">Key Differences from Standard Triplet Training<a class="headerlink" href="#key-differences-from-standard-triplet-training" title="Permanent link">&para;</a></h2>
<p>Unlike standard triplet training, the distillation approach:
- Does <strong>NOT</strong> require pre-generated triplets file
- Samples positive and negative documents <strong>dynamically</strong> during training
- Requires <strong>similarity scores from a teacher model</strong> for distillation
- Augments training with soft labels from the teacher model
- Uses hard negatives (documents with high teacher scores but not marked as positive)</p>
<h2 id="file-format-ndjson">File Format: NDJSON<a class="headerlink" href="#file-format-ndjson" title="Permanent link">&para;</a></h2>
<p>All data files must be in NDJSON format, where:
- Each line is a valid JSON object
- Lines are separated by newline characters (<code>\n</code>)
- Each file can contain multiple JSON objects, one per line
- Files can be optionally gzip-compressed (<code>.ndjson.gz</code>)</p>
<h2 id="data-file-specifications">Data File Specifications<a class="headerlink" href="#data-file-specifications" title="Permanent link">&para;</a></h2>
<h3 id="1-query-master-file">1. Query Master File<a class="headerlink" href="#1-query-master-file" title="Permanent link">&para;</a></h3>
<p>Same as the Query Master File in <a href="../splade_triplet_data_format/###1-query-master-file">Triplet-based data format</a></p>
<h3 id="2-document-master-file">2. Document Master File<a class="headerlink" href="#2-document-master-file" title="Permanent link">&para;</a></h3>
<p>Same as the Document Master File in <a href="../splade_triplet_data_format/###2-document-master-file">Triplet-based data format</a></p>
<h3 id="3-positive-lists-file">3. Positive Lists File<a class="headerlink" href="#3-positive-lists-file" title="Permanent link">&para;</a></h3>
<p>Same as the Positive Lists File in <a href="../splade_triplet_data_format/###3-positive-lists-file">Triplet-based data format</a></p>
<h3 id="4-hard-negative-scores-file">4. Hard Negative Scores File<a class="headerlink" href="#4-hard-negative-scores-file" title="Permanent link">&para;</a></h3>
<p><strong>File naming convention</strong>: <code>hard-negatives-cross-encoder-scores.ndjson</code> or <code>hard_negative_scores.ndjson</code></p>
<p><strong>Purpose</strong>: Contains similarity scores from a teacher model (typically a strong cross-encoder) for query-document pairs. These scores are used for:
1. <strong>Knowledge distillation</strong> - The student model learns to mimic the teacher's scoring behavior
2. <strong>Hard negative mining</strong> - Selecting challenging negative examples (high teacher score but not marked as positive)</p>
<p><strong>Schema</strong></p>
<pre><code class="language-json">{
  &quot;qid&quot;: &lt;integer&gt;,
  &quot;scores&quot;: {
    &quot;&lt;doc_id&gt;&quot;: &lt;float&gt;,
    &quot;&lt;doc_id&gt;&quot;: &lt;float&gt;,
    ...
  }
}
</code></pre>
<p><strong>Fields</strong></p>
<ul>
<li><code>qid</code> (int): Query identifier (must exist in query master)</li>
<li><code>scores</code> (dict[int, float]): Dictionary mapping document IDs to their similarity scores from the teacher model<ul>
<li>Keys can be stored as strings or integers in JSON (will be converted to integers internally)</li>
<li>Values are floating-point scores from the teacher model</li>
</ul>
</li>
</ul>
<p><strong>Example</strong>:</p>
<pre><code class="language-json">{&quot;qid&quot;: 3, &quot;scores&quot;: {&quot;11&quot;: 0.95, &quot;12&quot;: 0.23, &quot;13&quot;: 0.15, &quot;100&quot;: 0.26}}
{&quot;qid&quot;: 4, &quot;scores&quot;: {&quot;16&quot;: 0.92, &quot;17&quot;: 0.31, &quot;18&quot;: 0.42}}
{&quot;qid&quot;: 5, &quot;scores&quot;: {&quot;21&quot;: 0.89, &quot;22&quot;: 0.18, &quot;23&quot;: 0.27}}
</code></pre>
<p><strong>Requirements</strong></p>
<ul>
<li>Every query in the positive list must have entries in the scores file</li>
<li>For each query, <strong>all positive documents</strong> must have scores</li>
<li>Scores should include hard negative candidates (documents with relatively high scores but not in the positive list)</li>
<li>The more candidate documents with scores, the better the hard negative mining</li>
</ul>
<p><strong>Notes on Teacher Scores</strong></p>
<ul>
<li>Teacher model is typically a cross-encoder (e.g., cross-encoder/ms-marco-MiniLM-L-12-v2)</li>
<li>Scores represent the teacher's assessment of query-document relevance</li>
<li>Higher scores indicate higher relevance according to the teacher</li>
<li>Hard negatives are selected from documents with high teacher scores that are NOT in the positive list</li>
</ul>
<h2 id="data-organization">Data Organization<a class="headerlink" href="#data-organization" title="Permanent link">&para;</a></h2>
<h3 id="directory-structure">Directory Structure<a class="headerlink" href="#directory-structure" title="Permanent link">&para;</a></h3>
<p>For a complete training setup with distillation, organize your data as follows:</p>
<pre><code>data/
├── train/
│   ├── query_master.ndjson
│   ├── doc_master.ndjson
│   └── positive_lists.ndjson
├── validation/
│   ├── query_master.ndjson
│   ├── doc_master.ndjson
│   └── positive_lists.ndjson
└── hard-negatives-cross-encoder-scores.ndjson.gz
</code></pre>
<p><strong>Important Notes</strong></p>
<ul>
<li>Hard negative scores file is typically <strong>shared</strong> between train and validation sets (placed at the root)</li>
<li>No separate triplets file is needed (triplets are sampled dynamically)</li>
<li>The scores file can be large, so gzip compression is recommended</li>
</ul>
<h3 id="configuration-example">Configuration Example<a class="headerlink" href="#configuration-example" title="Permanent link">&para;</a></h3>
<p>Reference your data files in the YAML configuration:</p>
<pre><code class="language-yaml">DATA_PATH: data/mmarco_ja_4_splade_distil

train_doc_master: ${.DATA_PATH}/train/doc_master.ndjson
train_query_master: ${.DATA_PATH}/train/query_master.ndjson
train_positives: ${.DATA_PATH}/train/positive_lists.ndjson

validation_doc_master: ${.DATA_PATH}/validation/doc_master.ndjson
validation_query_master: ${.DATA_PATH}/validation/query_master.ndjson
validation_positives: ${.DATA_PATH}/validation/positive_lists.ndjson

hard_negative_scores: ${.DATA_PATH}/hard-negatives-cross-encoder-scores.ndjson.gz
</code></pre>
<h2 id="sampling-modes">Sampling Modes<a class="headerlink" href="#sampling-modes" title="Permanent link">&para;</a></h2>
<p>The <code>TripletDistilDataset</code> supports different sampling strategies:</p>
<h3 id="query-based-sampling-default-currently-supported">Query-Based Sampling (Default, Currently Supported)<a class="headerlink" href="#query-based-sampling-default-currently-supported" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Dataset size</strong>: Equals the number of queries</li>
<li><strong>Behavior</strong>: For each epoch iteration:</li>
<li>One sample corresponds to one query</li>
<li>Positive document is <strong>randomly sampled</strong> from the query's positive list</li>
<li>Negative document is <strong>randomly sampled</strong> from hard negatives (documents with scores but not in positive list)</li>
<li><strong>Training recommendation</strong>: Use <strong>multi-epoch training</strong> to ensure all positive pairs are utilized over time</li>
<li><strong>Advantage</strong>: Balanced training across all queries</li>
</ul>
<h3 id="positive-pair-based-sampling-future-support">Positive-Pair-Based Sampling (Future Support)<a class="headerlink" href="#positive-pair-based-sampling-future-support" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>Dataset size</strong>: Equals the total number of positive pairs across all queries</li>
<li><strong>Behavior</strong>: One sample corresponds to one (query, positive document) pair</li>
<li><strong>Training recommendation</strong>: Single epoch covers all positive pairs</li>
<li><strong>Advantage</strong>: Ensures all positive pairs are seen in one epoch</li>
</ul>
<h2 id="data-validation-rules">Data Validation Rules<a class="headerlink" href="#data-validation-rules" title="Permanent link">&para;</a></h2>
<p>The <code>TripletDistilDataset</code> class enforces the following validation rules:</p>
<ol>
<li><strong>Query Coverage</strong>: Every query ID in the positive list must exist in the query master</li>
<li><strong>Query Completeness</strong>: Every query ID in the query master must have entries in the positive list</li>
<li><strong>Document Existence</strong>: All document IDs referenced in the positive lists must exist in the document master</li>
<li><strong>Positive Requirement</strong>: Every query must have at least one positive document</li>
<li><strong>Negative Availability</strong>: Every query must have at least one available negative document (in scores but not in positive list and exists in document master)</li>
<li><strong>Positive Score Requirement</strong>: Every (query, positive document) pair must have a teacher score in the hard negative scores file</li>
</ol>
<p>If any validation rule fails, the system will raise a <code>ValueError</code> with a specific error message including the problematic ID for easy debugging.</p>
<h2 id="dataset-output">Dataset Output<a class="headerlink" href="#dataset-output" title="Permanent link">&para;</a></h2>
<p>When loading a sample from the <code>TripletDistilDataset</code>, you receive a <strong>5-tuple</strong>:</p>
<pre><code class="language-python">(query_text, positive_doc_text, negative_doc_text, positive_score, negative_score)
</code></pre>
<p><strong>Fields</strong></p>
<ol>
<li><code>query_text</code> (str): The query text</li>
<li><code>positive_doc_text</code> (str): The positive (relevant) document text</li>
<li><code>negative_doc_text</code> (str): The negative (hard negative) document text</li>
<li><code>positive_score</code> (float): Teacher model's similarity score for (query, positive_doc) pair</li>
<li><code>negative_score</code> (float): Teacher model's similarity score for (query, negative_doc) pair</li>
</ol>
<p><strong>Example</strong></p>
<pre><code class="language-python">(
  &quot;Gitでコミットを取り消すにはどうすればよい？&quot;,
  &quot;直前のコミットを取り消すにはgit reset --softやgit revertを状況に応じて使い分けます。&quot;,
  &quot;雨天時は運動会が体育館で実施される予定です。&quot;,
  0.95,
  0.23
)
</code></pre>
<h2 id="use-case">Use Case<a class="headerlink" href="#use-case" title="Permanent link">&para;</a></h2>
<p>This data format is designed for <strong>SPLADE training with knowledge distillation</strong>, where:</p>
<ol>
<li><strong>Knowledge Transfer</strong>: The student model (SPLADE) learns from a strong teacher model (typically a cross-encoder)</li>
<li><strong>Hard Negative Mining</strong>: Negative documents are sampled from candidates that the teacher rates highly but are not actually relevant</li>
<li><strong>Soft Labels</strong>: Teacher scores provide soft supervision signals in addition to hard labels (positive/negative)</li>
</ol>
<p>The model learns to</p>
<ul>
<li>Score queries and documents in a sparse lexical space</li>
<li>Mimic the teacher model's scoring behavior through distillation loss</li>
<li>Rank positive documents higher than negative documents</li>
<li>Learn from challenging hard negatives</li>
<li>Produce sparse, interpretable representations</li>
</ul>
<p>According to the <a href="https://arxiv.org/pdf/2010.02666">SPLADE v2bis</a> paper, distillation training achieves higher accuracy than training without distillation (e.g., the triplet-based training described in <a href="../splade_triplet_data_format/">splade_triplet_data_format.md</a>).</p>
<h2 id="generating-hard-negative-scores">Generating Hard Negative Scores<a class="headerlink" href="#generating-hard-negative-scores" title="Permanent link">&para;</a></h2>
<p>To create the hard negative scores file, you typically</p>
<ol>
<li><strong>Select a Teacher Model</strong>: Use a strong cross-encoder</li>
<li><strong>Generate Candidate Pool</strong>: For each query, retrieve top-k documents using BM25 or another retrieval method (e.g., k=100-1000). Also add the positive documents to the candidate pool.</li>
<li><strong>Score Pairs</strong>: Use the teacher model to score all (query, candidate_document) pairs</li>
<li><strong>Save Scores</strong>: Store scores in the required NDJSON format</li>
</ol>
<h2 id="reference">Reference<a class="headerlink" href="#reference" title="Permanent link">&para;</a></h2>
<ul>
<li>Implementation: <a href="../src/light_splade/data/triplet_distil_dataset.py">triplet_distil_dataset.py</a></li>
<li>Score loader: <a href="../src/light_splade/data/pair_score.py">pair_score.py</a></li>
<li>Data schemas: <a href="../src/light_splade/schemas/data/__init__.py">schemas/data/<strong>init</strong>.py</a></li>
<li>Example config: <a href="../config/data/splade_data_mmarco_ja_distill.yaml">splade_data_mmarco_ja_distill.yaml</a></li>
</ul>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../splade_triplet_data_format/" class="btn btn-neutral float-left" title="Triplet-based"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../trouble_shooting/" class="btn btn-neutral float-right" title="Troubleshooting">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
    
      <span><a href="../splade_triplet_data_format/" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../trouble_shooting/" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script src="../js/jquery-3.6.0.min.js"></script>
    <script>var base_url = "..";</script>
    <script src="../js/theme_extra.js"></script>
    <script src="../js/theme.js"></script>
    <script>
        jQuery(function () {
            SphinxRtdTheme.Navigation.enable(true);
        });
    </script>

</body>
</html>
